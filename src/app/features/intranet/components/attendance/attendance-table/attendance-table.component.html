<!-- #region Template -->
<section class="attendance-section">
	<div class="section-header">
		<div class="section-title-row">
			<h2>
				@if (hasHijos()) {
					<!-- * Inline selector when multiple children are available -->
					{{ table().title.split(' de ')[0] }} de
					<p-select
						[options]="hijosOptions()"
						[ngModel]="selectedHijoId()"
						(ngModelChange)="onHijoChange($event)"
						optionLabel="label"
						optionValue="value"
						class="hijo-select"
						[style]="{ minWidth: '200px' }"
						[filter]="true"
						filterBy="label"
						filterPlaceholder="Buscar..."
						[pt]="{
							root: {
								'aria-label': 'Seleccionar estudiante',
							},
						}"
					>
						<!-- * Selected: show only name, grade as tooltip -->
						<ng-template #selectedItem let-selectedOption>
							<span
								[pTooltip]="selectedOption.gradeInfo"
								tooltipPosition="top"
							>
								{{ selectedOption.shortLabel }}
							</span>
						</ng-template>
						<!-- * Dropdown list: show full label for clarity -->
						<ng-template #item let-option>
							{{ option.label }}
						</ng-template>
					</p-select>
				} @else {
					{{ table().title }}
				}
			</h2>
			<!-- * Status summary badges -->
			<div class="status-summary">
				<div class="summary-item">
					<span class="summary-color status-temprano"></span>
					<span class="summary-count">{{ table().counts.T }}T</span>
				</div>
				<div class="summary-item">
					<span class="summary-color status-atiempo"></span>
					<span class="summary-count">{{ table().counts.A }}A</span>
				</div>
				<div class="summary-item">
					<span class="summary-color status-fuera"></span>
					<span class="summary-count">{{ table().counts.F }}F</span>
				</div>
				<div class="summary-item">
					<span class="summary-color status-no"></span>
					<span class="summary-count">{{ table().counts.N }}N</span>
				</div>
			</div>
		</div>
		<!-- * Month selector for the current table -->
		<p-select
			[options]="monthOptions"
			[ngModel]="table().selectedMonth"
			(ngModelChange)="onMonthChange($event)"
			optionLabel="label"
			optionValue="value"
			class="month-select"
			[filter]="true"
			filterBy="label"
			filterPlaceholder="Buscar mes..."
			[pt]="{
				root: {
					'aria-label': 'Seleccionar mes',
				},
			}"
		/>
	</div>

	<!-- * Double-entry attendance grid -->
	<p-table [value]="table().weeks" class="attendance-table double-entry">
		<ng-template pTemplate="header">
			<tr>
				<th class="week-col header-cell"></th>
				@for (day of dayHeaders; track day) {
					<th class="day-col">{{ day }}</th>
				}
				<th class="total-col">Total</th>
			</tr>
		</ng-template>
		<ng-template pTemplate="body" let-week>
			<tr>
				<td class="week-col header-cell">{{ week.week }}</td>
				@for (day of week.days; track $index) {
					<td class="day-col">
						@if (isDayValid(day)) {
							@if (day.status === 'X') {
								<!-- ! Before registration start: show disabled day -->
								<div class="day-cell day-no-registro">
									<span class="day-number">{{ day.date | date: 'd' }}</span>
								</div>
							} @else if (day.status === '-') {
								<!-- * Pending day (future or today without time) -->
								<div class="day-cell status-pendiente">
									<span class="day-number">{{ day.date | date: 'd' }}</span>
									<span class="day-status">-</span>
								</div>
							} @else {
								<!-- * Normal day with status code -->
								<div class="day-cell" [class]="getStatusClass(day.status)">
									<span class="day-number">{{ day.date | date: 'd' }}</span>
									<span class="day-status">{{ day.status }}</span>
									@if (day.hora) {
										<span class="day-hora">{{ day.hora }}</span>
									}
								</div>
							}
						} @else {
							<!-- * Empty cells keep grid alignment -->
							<div class="day-cell day-empty"></div>
						}
					</td>
				}
				<td class="total-col">{{ week.total }}</td>
			</tr>
		</ng-template>
		<ng-template pTemplate="footer">
			<tr>
				<td class="week-col header-cell">Total</td>
				@for (total of table().columnTotals; track $index) {
					<td class="day-col footer-total">{{ total }}</td>
				}
				<td class="total-col footer-total grand-total">{{ table().grandTotal }}</td>
			</tr>
		</ng-template>
	</p-table>
</section>
<!-- #endregion -->
