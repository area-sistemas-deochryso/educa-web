<p-card class="asistencia-dia-card">
	<ng-template #header>
		<div class="card-header">
			<h2><i class="pi pi-calendar-clock"></i> Asistencia del día</h2>
			<div class="header-actions">
				@if (showPdfButton()) {
					<!-- * PDF actions -->
					<p-button
						icon="pi pi-file-pdf"
						[loading]="downloadingPdf()"
						severity="danger"
						[text]="true"
						[rounded]="true"
						(onClick)="togglePdfMenu($event)"
						pTooltip="Opciones de PDF"
						tooltipPosition="top"
						class="pdf-button"
						[pt]="{
							root: {
								'aria-label': 'Opciones de PDF',
							},
						}"
					/>
					<p-menu #pdfMenu [model]="pdfMenuItems()" [popup]="true" appendTo="body" />
					<!-- * Report label -->
					<span class="pdf-label"> Reporte de la fecha</span>
				}
				<!-- * Date picker (max = today) -->
				<p-datepicker
					[(ngModel)]="fechaValue"
					[showIcon]="true"
					[maxDate]="today"
					dateFormat="dd/mm/yy"
					(ngModelChange)="onFechaChange($event)"
					class="fecha-picker"
				/>
			</div>
		</div>
	</ng-template>

	@if (loading()) {
		<!-- * Skeleton rows while loading -->
		<div class="skeleton-container">
			@for (_ of skeletonRows; track $index) {
				<p-skeleton height="3rem" class="skeleton-row" />
			}
		</div>
	} @else if (estudiantesDelDia().length === 0) {
		<!-- ! Empty state when there is no data -->
		<div class="empty-state">
			<i class="pi pi-users"></i>
			<p>No hay registros de asistencia para esta fecha</p>
		</div>
	} @else {
		<!-- * Day list table -->
		<p-table [value]="estudiantesDelDia()" class="p-datatable-sm asistencia-table">
			<ng-template #header>
				<tr>
					<th style="width: 50px">#</th>
					<th>Estudiante</th>
					<th style="width: 100px" class="text-center">Entrada</th>
					<th style="width: 100px" class="text-center">Salida</th>
					<th style="width: 80px" class="text-center">Estado</th>
				</tr>
			</ng-template>
			<ng-template #body let-estudiante let-i="rowIndex">
				<tr
					[class.row-clickable]="allowJustify() && estudiante.puedeJustificar"
					[pTooltip]="
						allowJustify() && estudiante.puedeJustificar
							? estudiante.esJustificado
								? 'Clic para editar/quitar justificación'
								: 'Clic para justificar'
							: ''
					"
					tooltipPosition="top"
					[appendTo]="'body'"
					[tooltipOptions]="{ showDelay: 300 }"
					(click)="onEstudianteClick(estudiante)"
				>
					<td class="row-number">{{ i + 1 }}</td>
					<td>
						<!-- * Name + DNI + Observación -->
						<div class="estudiante-info">
							<span class="nombre">{{ estudiante.nombreCompleto }}</span>
							<span class="dni">DNI: {{ estudiante.dni }}</span>
							@if (estudiante.observacion) {
								<span
									class="observacion"
									pTooltip="{{ estudiante.observacion }}"
									tooltipPosition="top"
								>
									<i class="pi pi-info-circle"></i>
									{{ estudiante.observacion | slice: 0 : 30
									}}{{ estudiante.observacion.length > 30 ? '...' : '' }}
								</span>
							}
						</div>
					</td>
					<td class="text-center">
						<!-- * Entry time -->
						<span class="hora" [class.hora-empty]="!estudiante.horaEntrada">
							@if (estudiante.horaEntrada) {
								<i class="pi pi-sign-in"></i>
							}
							{{ formatTime(estudiante.horaEntrada) }}
						</span>
					</td>
					<td class="text-center">
						<!-- * Exit time -->
						<span class="hora" [class.hora-empty]="!estudiante.horaSalida">
							@if (estudiante.horaSalida) {
								<i class="pi pi-sign-out"></i>
							}
							{{ formatTime(estudiante.horaSalida) }}
						</span>
					</td>
					<td class="text-center">
						<!-- * Status code -->
						<span class="estado-box" [class]="getStatusClass(estudiante.estadoCodigo)">
							{{ estudiante.estadoCodigo }}
						</span>
					</td>
				</tr>
			</ng-template>
		</p-table>

		<!-- * Footer stats summary -->
		<div class="resumen-footer">
			<div class="stat-badge total">
				<div class="badge-icon">
					<i class="pi pi-users"></i>
				</div>
				<div class="badge-content">
					<span class="value">{{ estadisticas().total }}</span>
					<span class="label">Total</span>
				</div>
			</div>
			<div class="stat-badge temprano">
				<span class="status-indicator status-temprano">T</span>
				<div class="badge-content">
					<span class="value">{{ estadisticas().temprano }}</span>
					<span class="label">Temprano</span>
				</div>
			</div>
			<div class="stat-badge atiempo">
				<span class="status-indicator status-atiempo">A</span>
				<div class="badge-content">
					<span class="value">{{ estadisticas().aTiempo }}</span>
					<span class="label">A tiempo</span>
				</div>
			</div>
			<div class="stat-badge fuera">
				<span class="status-indicator status-fuera">F</span>
				<div class="badge-content">
					<span class="value">{{ estadisticas().fueraHora }}</span>
					<span class="label">Fuera hora</span>
				</div>
			</div>
			<div class="stat-badge no-asistio">
				<span class="status-indicator status-no">N</span>
				<div class="badge-content">
					<span class="value">{{ estadisticas().noAsistio }}</span>
					<span class="label">No asistió</span>
				</div>
			</div>
			<div class="stat-badge justificado">
				<span class="status-indicator status-justificado">J</span>
				<div class="badge-content">
					<span class="value">{{ estadisticas().justificado }}</span>
					<span class="label">Justificado</span>
				</div>
			</div>
			<div class="stat-badge pendiente">
				<span class="status-indicator status-pendiente">-</span>
				<div class="badge-content">
					<span class="value">{{ estadisticas().pendiente }}</span>
					<span class="label">Pendiente</span>
				</div>
			</div>
		</div>
	}
</p-card>

<!-- ============ Diálogo de Justificación ============ -->
<p-dialog
	[visible]="dialogVisible()"
	(visibleChange)="onDialogVisibleChange($event)"
	[modal]="true"
	[draggable]="false"
	[resizable]="false"
	[closable]="true"
	[header]="
		selectedEstudiante()?.esJustificado ? 'Editar Justificación' : 'Justificar Asistencia'
	"
	styleClass="justificacion-dialog"
	[style]="{ width: '450px' }"
	appendTo="body"
>
	@if (selectedEstudiante(); as estudiante) {
		<div class="dialog-content">
			<div class="estudiante-header">
				<div class="avatar">
					<i class="pi pi-user"></i>
				</div>
				<div class="info">
					<span class="nombre">{{ estudiante.nombreCompleto }}</span>
					<span class="dni">DNI: {{ estudiante.dni }}</span>
				</div>
			</div>

			<div class="field">
				<label for="observacion"
					>Motivo de la justificación <span class="required">*</span></label
				>
				<textarea
					pTextarea
					id="observacion"
					rows="4"
					[ngModel]="observacionText()"
					(ngModelChange)="observacionText.set($event)"
					placeholder="Ingrese el motivo de la justificación (ej: Cita médica, motivo familiar, etc.)"
					class="w-full"
				></textarea>
			</div>

			<div class="dialog-footer">
				@if (estudiante.esJustificado) {
					<p-button
						label="Quitar justificación"
						severity="danger"
						[text]="true"
						icon="pi pi-trash"
						[loading]="savingJustificacion()"
						(onClick)="quitarJustificacion()"
					/>
				}
				<p-button
					label="Cancelar"
					severity="secondary"
					[text]="true"
					(onClick)="closeDialog()"
				/>
				<p-button
					label="Guardar"
					icon="pi pi-check"
					[loading]="savingJustificacion()"
					[disabled]="!observacionText().trim()"
					(onClick)="guardarJustificacion()"
				/>
			</div>
		</div>
	}
</p-dialog>
