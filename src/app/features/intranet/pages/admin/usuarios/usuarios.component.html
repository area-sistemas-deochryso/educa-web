<div class="usuarios-container">
	<!-- Header -->
	<header class="page-header">
		<div class="header-left">
			<div class="header-icon">
				<i class="pi pi-users"></i>
			</div>
			<div class="header-text">
				<h1>Administracion de Usuarios</h1>
				<p>Gestiona todos los usuarios del sistema</p>
			</div>
		</div>
		<button
			pButton
			label="Refrescar"
			icon="pi pi-refresh"
			class="p-button-outlined"
			(click)="refresh()"
			[pt]="{
				root: {
					'aria-label': 'Refrescar',
				},
			}"
		></button>
	</header>

	<!-- Stats Cards - Progressive Rendering -->
	@if (vm().showSkeletons && !vm().statsReady) {
		<!-- Skeleton mostrado inmediatamente -->
		<app-usuarios-stats-skeleton />
	} @else if (vm().hasEstadisticas) {
		<!-- Contenido real -->
		<section class="stats-section">
			<div class="stat-card">
				<div class="stat-content">
					<span class="stat-label">Total Usuarios</span>
					<span class="stat-value">{{ vm().estadisticas!.totalUsuarios }}</span>
					<span class="stat-sublabel">usuarios registrados</span>
				</div>
				<div class="stat-icon">
					<i class="pi pi-users"></i>
				</div>
			</div>

			<div class="stat-card">
				<div class="stat-content">
					<span class="stat-label">Directores</span>
					<span class="stat-value">{{ vm().estadisticas!.totalDirectores }}</span>
					<span class="stat-sublabel">administradores</span>
				</div>
				<div class="stat-icon">
					<i class="pi pi-user"></i>
				</div>
			</div>

			<div class="stat-card">
				<div class="stat-content">
					<span class="stat-label">Asistentes Admin.</span>
					<span class="stat-value">{{
						vm().estadisticas!.totalAsistentesAdministrativos
					}}</span>
					<span class="stat-sublabel">apoyo administrativo</span>
				</div>
				<div class="stat-icon">
					<i class="pi pi-user-edit"></i>
				</div>
			</div>

			<div class="stat-card">
				<div class="stat-content">
					<span class="stat-label">Profesores</span>
					<span class="stat-value">{{ vm().estadisticas!.totalProfesores }}</span>
					<span class="stat-sublabel">docentes</span>
				</div>
				<div class="stat-icon">
					<i class="pi pi-graduation-cap"></i>
				</div>
			</div>

			<div class="stat-card">
				<div class="stat-content">
					<span class="stat-label">Estudiantes</span>
					<span class="stat-value">{{ vm().estadisticas!.totalEstudiantes }}</span>
					<span class="stat-sublabel">alumnos</span>
				</div>
				<div class="stat-icon">
					<i class="pi pi-book"></i>
				</div>
			</div>
		</section>
	} @else {
		<!-- Fallback sin datos -->
		<section class="stats-section">
			<div class="stat-card">
				<div class="stat-content">
					<span class="stat-label">Total Usuarios</span>
					<span class="stat-value">0</span>
					<span class="stat-sublabel">usuarios registrados</span>
				</div>
				<div class="stat-icon">
					<i class="pi pi-users"></i>
				</div>
			</div>

			<div class="stat-card">
				<div class="stat-content">
					<span class="stat-label">Directores</span>
					<span class="stat-value">0</span>
					<span class="stat-sublabel">administradores</span>
				</div>
				<div class="stat-icon">
					<i class="pi pi-user"></i>
				</div>
			</div>

			<div class="stat-card">
				<div class="stat-content">
					<span class="stat-label">Asistentes Admin.</span>
					<span class="stat-value">0</span>
					<span class="stat-sublabel">apoyo administrativo</span>
				</div>
				<div class="stat-icon">
					<i class="pi pi-user-edit"></i>
				</div>
			</div>

			<div class="stat-card">
				<div class="stat-content">
					<span class="stat-label">Profesores</span>
					<span class="stat-value">0</span>
					<span class="stat-sublabel">docentes</span>
				</div>
				<div class="stat-icon">
					<i class="pi pi-graduation-cap"></i>
				</div>
			</div>

			<div class="stat-card">
				<div class="stat-content">
					<span class="stat-label">Estudiantes</span>
					<span class="stat-value">0</span>
					<span class="stat-sublabel">alumnos</span>
				</div>
				<div class="stat-icon">
					<i class="pi pi-book"></i>
				</div>
			</div>
		</section>
	}

	<!-- Filters -->
	<section class="filters-section">
		<div class="search-box">
			<i class="pi pi-search"></i>
			<input
				type="text"
				pInputText
				placeholder="Buscar por nombre, DNI o correo..."
				[ngModel]="vm().searchTerm"
				(ngModelChange)="onSearchChange($event)"
			/>
		</div>

		<p-select
			[options]="rolesOptions"
			[ngModel]="vm().filterRol"
			(ngModelChange)="onFilterRolChange($event)"
			placeholder="Todos los roles"
			[style]="{ minWidth: '160px' }"
		/>

		<p-select
			[options]="estadoOptions"
			[ngModel]="vm().filterEstado"
			(ngModelChange)="onFilterEstadoChange($event)"
			placeholder="Estado"
			[style]="{ minWidth: '140px' }"
		/>

		<button
			pButton
			label="Limpiar"
			icon="pi pi-filter-slash"
			class="p-button-text"
			(click)="clearFilters()"
			[pt]="{
				root: {
					'aria-label': 'Limpiar',
				},
			}"
		></button>

		<div class="filter-spacer"></div>

		<button
			pButton
			label="Nuevo Usuario"
			icon="pi pi-plus"
			class="p-button-success"
			(click)="openNew()"
			[pt]="{
				root: {
					'aria-label': 'Nuevo Usuario',
				},
			}"
		></button>
	</section>

	<!-- Table - Progressive Rendering -->
	@if (vm().showSkeletons && !vm().tableReady) {
		<!-- Skeleton mostrado inmediatamente con espacio reservado -->
		<section class="table-section" style="min-height: 420px;">
			<app-usuarios-table-skeleton />
		</section>
	} @else {
		<!-- Tabla real -->
		<section
			class="table-section"
			appTableLoading
			[loading]="vm().loading"
			[freezeHeight]="true"
			[minHeightPx]="420"
			[blurPx]="2"
		>
			<p-table
				[value]="vm().filteredUsuarios"
				[paginator]="true"
				[rows]="10"
				[rowsPerPageOptions]="[5, 10, 25, 50]"
				[showCurrentPageReport]="true"
				currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} usuarios"
				class="p-datatable-sm"
			>
			<ng-template #header>
				<tr>
					<th style="width: 80px" pSortableColumn="id">ID <p-sortIcon field="id" /></th>
					<th style="width: 100px" pSortableColumn="dni">
						DNI <p-sortIcon field="dni" />
					</th>
					<th pSortableColumn="nombreCompleto">
						NOMBRE <p-sortIcon field="nombreCompleto" />
					</th>
					<th style="width: 120px" pSortableColumn="rol">
						ROL <p-sortIcon field="rol" />
					</th>
					<th style="width: 100px" pSortableColumn="estado">
						ESTADO <p-sortIcon field="estado" />
					</th>
					<th style="width: 140px">ACCIONES</th>
				</tr>
			</ng-template>

			<ng-template #body let-usuario>
				<tr [class.row-inactive]="!usuario.estado">
					<td class="text-center">
						<span class="id-badge">{{ usuario.id }}</span>
					</td>
					<td>
						<span class="dni-text">{{ usuario.dni }}</span>
					</td>
					<td>
						<div class="user-cell">
							<div class="user-avatar">
								<i class="pi pi-user"></i>
							</div>
							<div class="user-info">
								<span class="user-name">{{ usuario.nombreCompleto }}</span>
								@if (usuario.correo) {
									<span class="user-email">{{ usuario.correo }}</span>
								}
							</div>
						</div>
					</td>
					<td>
						<p-tag
							[value]="usuario.rol"
							[severity]="adminUtils.getRolSeverity(usuario.rol)"
						/>
					</td>
					<td class="text-center">
						<p-tag
							[value]="usuario.estado ? 'Activo' : 'Inactivo'"
							[severity]="adminUtils.getEstadoSeverity(usuario.estado)"
						/>
					</td>
					<td>
						<div class="actions">
							<button
								pButton
								icon="pi pi-eye"
								class="p-button-rounded p-button-text p-button-secondary"
								pTooltip="Ver detalles"
								aria-label="Ver detalles"
								(click)="openDetail(usuario)"
								[pt]="{
									root: {
										'aria-label': 'Ver detalles',
									},
								}"
							></button>
							<button
								pButton
								icon="pi pi-pencil"
								class="p-button-rounded p-button-text p-button-info"
								pTooltip="Editar"
								aria-label="Editar"
								(click)="editUsuario(usuario)"
								[pt]="{
									root: {
										'aria-label': 'Editar',
									},
								}"
							></button>
							<button
								pButton
								[icon]="usuario.estado ? 'pi pi-ban' : 'pi pi-check'"
								class="p-button-rounded p-button-text"
								[class.p-button-warning]="usuario.estado"
								[class.p-button-success]="!usuario.estado"
								[pTooltip]="usuario.estado ? 'Desactivar' : 'Activar'"
								tooltipPosition="left"
								[attr.aria-label]="usuario.estado ? 'Desactivar' : 'Activar'"
								(click)="toggleEstado(usuario)"
								[pt]="{
									root: {
										'aria-label': `${usuario.estado ? 'Desactivar' : 'Activar'}`,
									},
								}"
							></button>
						</div>
					</td>
				</tr>
			</ng-template>

			<ng-template #emptymessage>
				<tr>
					<td colspan="6" class="empty-message">
						<div class="empty-state">
							<i class="pi pi-users"></i>
							<p>No se encontraron usuarios</p>
							<span>Intenta ajustar los filtros de busqueda</span>
						</div>
					</td>
				</tr>
			</ng-template>
			</p-table>
		</section>
	}
</div>

<!-- Detail Drawer -->
<p-drawer
	[visible]="vm().detailDrawerVisible"
	(visibleChange)="onDrawerVisibleChange($event)"
	position="right"
	[style]="{ width: '450px' }"
	[modal]="true"
>
	<ng-template pTemplate="header">
		<div class="drawer-header">
			<span>Detalles del Usuario</span>
		</div>
	</ng-template>

	@if (vm().selectedUsuario) {
		<div class="detail-content">
			<div class="detail-avatar">
				<i class="pi pi-user"></i>
			</div>

			<div class="detail-name">{{ vm().selectedUsuario!.nombreCompleto }}</div>

			<p-tag
				[value]="vm().selectedUsuario!.rol"
				[severity]="adminUtils.getRolSeverity(vm().selectedUsuario!.rol)"
			/>

			<div class="detail-info">
				<div class="info-item">
					<span class="info-label">DNI</span>
					<span class="info-value">{{ vm().selectedUsuario!.dni }}</span>
				</div>
				<div class="info-item">
					<span class="info-label">Estado</span>
					<p-tag
						[value]="vm().selectedUsuario!.estado ? 'Activo' : 'Inactivo'"
						[severity]="adminUtils.getEstadoSeverity(vm().selectedUsuario!.estado)"
					/>
				</div>
				@if (vm().selectedUsuario!.correo) {
					<div class="info-item">
						<span class="info-label">Correo</span>
						<span class="info-value">{{ vm().selectedUsuario!.correo }}</span>
					</div>
				}
				@if (vm().selectedUsuario!.telefono) {
					<div class="info-item">
						<span class="info-label">Telefono</span>
						<span class="info-value">{{ vm().selectedUsuario!.telefono }}</span>
					</div>
				}
				@if (vm().selectedUsuario!.sedeNombre) {
					<div class="info-item">
						<span class="info-label">Sede</span>
						<span class="info-value">{{ vm().selectedUsuario!.sedeNombre }}</span>
					</div>
				}
				@if (vm().selectedUsuario!.grado) {
					<div class="info-item">
						<span class="info-label">Grado</span>
						<span class="info-value">{{ vm().selectedUsuario!.grado }}</span>
					</div>
				}
				@if (vm().selectedUsuario!.seccion) {
					<div class="info-item">
						<span class="info-label">Seccion</span>
						<span class="info-value">{{ vm().selectedUsuario!.seccion }}</span>
					</div>
				}
				@if (vm().selectedUsuario!.correoApoderado) {
					<div class="info-item">
						<span class="info-label">Correo del Apoderado</span>
						<span class="info-value">{{ vm().selectedUsuario!.correoApoderado }}</span>
					</div>
				}
				<div class="info-item">
					<span class="info-label">Fecha de Registro</span>
					<span class="info-value">{{
						vm().selectedUsuario!.fechaRegistro | date: 'dd/MM/yyyy'
					}}</span>
				</div>
			</div>
		</div>

		<div class="drawer-footer">
			<button
				pButton
				label="Cerrar"
				icon="pi pi-times"
				class="p-button-text"
				(click)="closeDetail()"
				[pt]="{
					root: {
						'aria-label': 'Cerrar',
					},
				}"
			></button>
			<button
				pButton
				label="Editar"
				icon="pi pi-pencil"
				class="p-button-primary"
				[pt]="{
					root: {
						'aria-label': 'Editar',
					},
				}"
				(click)="editFromDetail()"
			></button>
		</div>
	}
</p-drawer>

<!-- Edit/Create Dialog - SIEMPRE en el DOM para evitar problemas con scroll -->
<p-dialog
		[visible]="vm().dialogVisible"
		(visibleChange)="onDialogVisibleChange($event)"
		[header]="vm().isEditing ? 'Editar Usuario' : 'Nuevo Usuario'"
		[modal]="true"
		[style]="{ width: '600px' }"
		[draggable]="false"
		[resizable]="false"
		class="edit-usuario-dialog"
	>
		<div class="dialog-content">
			<div class="form-grid">
				@if (!vm().isEditing) {
					<div class="field full-width">
						<label for="rol">Rol *</label>
						<p-select
							id="rol"
							[options]="rolesSelectOptions"
							[ngModel]="vm().formData.rol"
							(ngModelChange)="onFieldChange('rol', $event)"
							placeholder="Seleccione el rol"
							[style]="{ width: '100%' }"
						/>
					</div>
				}

				<div class="field">
					<label for="dni">DNI *</label>
					<input
						id="dni"
						type="text"
						pInputText
						[ngModel]="vm().formData.dni"
						(ngModelChange)="onFieldChange('dni', $event)"
						placeholder="12345678"
						maxlength="8"
						[class.ng-invalid]="vm().dniError"
						[class.ng-dirty]="vm().formData.dni"
					/>
					<app-form-field-error [error]="vm().dniError" />
				</div>

				<div class="field">
					<label for="contrasena">{{
						vm().isEditing ? 'Nueva Contraseña' : 'Contraseña *'
					}}</label>
					<p-password
						id="contrasena"
						[ngModel]="vm().formData.contrasena"
						(ngModelChange)="onFieldChange('contrasena', $event)"
						[placeholder]="
							vm().isEditing ? 'Dejar vacío para mantener' : 'Ingrese contrasena'
						"
						[toggleMask]="true"
						[feedback]="false"
						[style]="{ width: '100%' }"
						[inputStyle]="{ width: '100%' }"
					/>
				</div>

				<div class="field">
					<label for="nombres">Nombres *</label>
					<input
						id="nombres"
						type="text"
						pInputText
						[ngModel]="vm().formData.nombres"
						(ngModelChange)="onFieldChange('nombres', $event)"
						placeholder="Nombres del usuario"
					/>
				</div>

				<div class="field">
					<label for="apellidos">Apellidos *</label>
					<input
						id="apellidos"
						type="text"
						pInputText
						[ngModel]="vm().formData.apellidos"
						(ngModelChange)="onFieldChange('apellidos', $event)"
						placeholder="Apellidos del usuario"
					/>
				</div>

				<div class="field">
					<label for="correo">Correo</label>
					<input
						id="correo"
						type="email"
						pInputText
						[ngModel]="vm().formData.correo"
						(ngModelChange)="onFieldChange('correo', $event)"
						placeholder="correo@ejemplo.com"
						[class.ng-invalid]="vm().correoError"
						[class.ng-dirty]="vm().formData.correo"
					/>
					<app-form-field-error [error]="vm().correoError" />
				</div>

				<div class="field">
					<label for="telefono">Telefono</label>
					<input
						id="telefono"
						type="text"
						pInputText
						[ngModel]="vm().formData.telefono"
						(ngModelChange)="onFieldChange('telefono', $event)"
						placeholder="999999999"
					/>
				</div>

				@if (vm().isEstudiante) {
					<div class="field">
						<label for="correoApoderado">Correo del Apoderado</label>
						<input
							id="correoApoderado"
							type="email"
							pInputText
							[ngModel]="vm().formData.correoApoderado"
							(ngModelChange)="onFieldChange('correoApoderado', $event)"
							placeholder="correo@ejemplo.com"
							[class.ng-invalid]="vm().correoApoderadoError"
							[class.ng-dirty]="vm().formData.correoApoderado"
						/>
						<app-form-field-error [error]="vm().correoApoderadoError" />
					</div>
				}

				@if (vm().isEditing) {
					<div class="field full-width">
						<label for="estado">Estado</label>
						<div class="estado-switch">
							<p-toggleswitch
								id="estado"
								[ngModel]="vm().formData.estado"
								(ngModelChange)="onFieldChange('estado', $event)"
							/>
							<span>{{ vm().formData.estado ? 'Activo' : 'Inactivo' }}</span>
						</div>
					</div>
				}
			</div>
		</div>

		<ng-template #footer>
			<div class="dialog-footer">
				<button
					pButton
					label="Cancelar"
					icon="pi pi-times"
					class="p-button-text"
					(click)="hideDialog()"
					[pt]="{
						root: {
							'aria-label': 'Cancelar',
						},
					}"
				></button>
				<button
					pButton
					label="Guardar"
					icon="pi pi-check"
					class="p-button-success"
					(click)="saveUsuario()"
					[disabled]="!vm().isFormValid"
					[pt]="{
						root: {
							'aria-label': 'Guardar',
						},
					}"
				></button>
			</div>
		</ng-template>
</p-dialog>

<!-- Confirm Dialog - SIEMPRE en el DOM (no usar @if para evitar timing issues) -->
<p-confirmDialog (onHide)="onConfirmDialogHide()" />
