<p-dialog
	[visible]="visible()"
	(visibleChange)="onVisibleChange($event)"
	[header]="isEditing() ? 'Editar Usuario' : 'Nuevo Usuario'"
	[modal]="true"
	[style]="{ width: '600px' }"
	[draggable]="false"
	[resizable]="false"
	class="edit-usuario-dialog"
>
	<div class="dialog-content">
		<div class="form-grid">
			<!-- ROL -->
			@if (!isEditing()) {
				<div class="field full-width">
					<label for="rol">Rol *</label>
					<p-select
						id="rol"
						[options]="rolesSelectOptions"
						[ngModel]="rolValue"
						(ngModelChange)="onFieldChange('rol', $event)"
						placeholder="Seleccione el rol"
						[style]="{ width: '100%' }"
					/>
				</div>
			}
			<!-- NOMBRES -->
			<div class="field">
				<label for="nombres">Nombres *</label>
				<input
					id="nombres"
					type="text"
					pInputText
					appUppercaseInput
					[ngModel]="formData().nombres"
					(ngModelChange)="onFieldChange('nombres', $event)"
					placeholder="Nombres del usuario"
				/>
			</div>
			<!-- APELLIDOS -->
			<div class="field">
				<label for="apellidos">Apellidos *</label>
				<input
					id="apellidos"
					type="text"
					pInputText
					appUppercaseInput
					[ngModel]="formData().apellidos"
					(ngModelChange)="onFieldChange('apellidos', $event)"
					placeholder="Apellidos del usuario"
				/>
			</div>
			<!-- DNI -->
			<div class="field">
				<label for="dni">DNI *</label>
				<input
					id="dni"
					type="text"
					pInputText
					[ngModel]="formData().dni"
					(ngModelChange)="onFieldChange('dni', $event)"
					placeholder="12345678"
					maxlength="8"
					[class.ng-invalid]="errors().dniError"
					[class.ng-dirty]="formData().dni"
				/>
				<app-form-field-error [error]="errors().dniError" />
			</div>
			<!-- CONTRASEÑA (readonly/autogenerada) -->
			<div class="field">
				<label for="contrasena" class="password-label">
					@if (!isEditing() || !canEditPassword()) {
						<i
							class="pi pi-lock"
							style="color: var(--red-500); margin-right: 0.5rem"
						></i>
					}
					@if (isEditing() && canEditPassword()) {
						<i
							class="pi pi-lock-open"
							style="color: var(--green-500); margin-right: 0.5rem"
						></i>
					}
					Contraseña
					@if (!isEditing() || !canEditPassword()) {
						<span>(autogenerada)</span>
					}
				</label>

				<p-password
					id="contrasena"
					[ngModel]="autoGeneratedValue()"
					(ngModelChange)="onFieldChange('contrasena', $event)"
					[disabled]="!isEditing() || !canEditPassword()"
					[toggleMask]="true"
					[feedback]="false"
					[style]="{ width: '100%' }"
					[inputStyle]="{ width: '100%' }"
					placeholder="Se generará automáticamente"
				></p-password>

				@if (!isEditing() || !canEditPassword()) {
					<small class="text-muted">
						<i class="pi pi-info-circle" style="margin-right: 0.25rem"></i>
						La contraseña se genera automáticamente
					</small>
				}
				@if (isEditing() && canEditPassword()) {
					<small class="text-muted">
						<i class="pi pi-info-circle" style="margin-right: 0.25rem"></i>
						Puede editar la contraseña
					</small>
				}
			</div>

			<!-- NOMBRE DEL APODERADO PARA ESTUDIANTE -->
			@if (isEstudiante) {
				<div class="field">
					<label for="nombreApoderado">
						Nombre del Apoderado
						<span style="color: var(--red-500)">*</span>
					</label>
					<input
						id="nombreApoderado"
						type="text"
						pInputText
						appUppercaseInput
						[ngModel]="formData().nombreApoderado"
						(ngModelChange)="onFieldChange('nombreApoderado', $event)"
						placeholder="Nombre completo del apoderado"
					/>
				</div>
			}
			<!-- TELEFONO -->
			@if (!isEstudiante) {
				<div class="field">
					<label for="telefono">Telefono</label>
					<input
						id="telefono"
						type="text"
						pInputText
						[ngModel]="formData().telefono"
						(ngModelChange)="onFieldChange('telefono', $event)"
						placeholder="999999999"
					/>
				</div>
			}
			<!-- TELEFONO DEL APODERADO PARA ESTUDIANTE -->
			@if (isEstudiante) {
				<div class="field">
					<label for="telefonoApoderado">
						Telefono del Apoderado
						<span style="color: var(--red-500)">*</span>
					</label>
					<input
						id="telefonoApoderado"
						type="text"
						pInputText
						[ngModel]="formData().telefonoApoderado"
						(ngModelChange)="onFieldChange('telefonoApoderado', $event)"
						placeholder="999999999 (obligatorio)"
					/>
				</div>
			}
			<!-- CORREO -->
			@if (!isEstudiante) {
				<div class="field">
					<label for="correo">Correo</label>
					<input
						id="correo"
						type="email"
						pInputText
						[ngModel]="formData().correo"
						(ngModelChange)="onFieldChange('correo', $event)"
						placeholder="correo@ejemplo.com"
						[class.ng-invalid]="errors().correoError"
						[class.ng-dirty]="formData().correo"
					/>
					<app-form-field-error [error]="errors().correoError" />
				</div>
			}
			<!-- CORREO APODERADO PARA ESTUDIANTE -->
			@if (isEstudiante) {
				<div class="field">
					<label for="correoApoderado">
						Correo del Apoderado
						<span style="color: var(--red-500)">*</span>
					</label>
					<input
						id="correoApoderado"
						type="email"
						pInputText
						[ngModel]="formData().correoApoderado"
						(ngModelChange)="onFieldChange('correoApoderado', $event)"
						placeholder="correo@ejemplo.com (obligatorio)"
						[class.ng-invalid]="errors().correoApoderadoError"
						[class.ng-dirty]="formData().correoApoderado"
					/>
					<app-form-field-error [error]="errors().correoApoderadoError" />
				</div>
			}
			<!-- SALÓN PARA PROFESOR (Grado) -->
			@if (isProfesor) {
				<div class="field">
					<label for="grado">Grado</label>
					<p-select
						id="grado"
						[options]="gradosOptions()"
						[ngModel]="_gradoSeleccionado()"
						(ngModelChange)="onGradoChange($event)"
						placeholder="Seleccione el grado"
						[style]="{ width: '100%' }"
						[showClear]="true"
						appendTo="body"
					/>
				</div>
			}
			<!-- SALÓN PARA PROFESOR (Sección) -->
			@if (isProfesor && _gradoSeleccionado()) {
				<div class="field">
					<label for="seccion">Sección</label>
					<p-select
						id="seccion"
						[options]="seccionesOptions()"
						[ngModel]="_seccionSeleccionada()"
						(ngModelChange)="onSeccionChange($event)"
						placeholder="Seleccione la sección"
						[style]="{ width: '100%' }"
						[showClear]="true"
						appendTo="body"
					/>
					<small class="text-muted">
						<i class="pi pi-info-circle" style="margin-right: 0.25rem"></i>
						Opcional: Asigne un salón al profesor
					</small>
				</div>
			}
			<!-- ES TUTOR PARA PROFESOR -->
			@if (isProfesor && formData().salonId) {
				<div class="field full-width">
					<div class="checkbox-container">
						<p-checkbox
							inputId="esTutor"
							[binary]="true"
							[ngModel]="formData().esTutor ?? false"
							(ngModelChange)="onFieldChange('esTutor', $event)"
						/>
						<label for="esTutor" class="checkbox-label">
							Es tutor de este salón
						</label>
					</div>
					<small class="text-muted">
						<i class="pi pi-info-circle" style="margin-right: 0.25rem"></i>
						Marque si el profesor será tutor del salón seleccionado
					</small>
				</div>
			}
			<!-- ESTADO -->
			@if (isEditing()) {
				<div class="field full-width">
					<label for="estado">Estado</label>
					<div class="estado-switch">
						<p-toggleswitch
							id="estado"
							[ngModel]="formData().estado"
							(ngModelChange)="onFieldChange('estado', $event)"
						/>
						<span>{{ formData().estado ? 'Activo' : 'Inactivo' }}</span>
					</div>
				</div>
			}
		</div>
	</div>

	<ng-template #footer>
		<div class="dialog-footer">
			<!-- CANCELAR -->
			<button
				pButton
				label="Cancelar"
				icon="pi pi-times"
				class="p-button-text"
				(click)="onCancel()"
				[pt]="{
					root: {
						'aria-label': 'Cancelar',
					},
				}"
			></button>
			<!-- GUARDAR -->
			<button
				pButton
				label="Guardar"
				icon="pi pi-check"
				class="p-button-success"
				(click)="onSave()"
				[disabled]="!isFormValid()"
				[pt]="{
					root: {
						'aria-label': 'Guardar',
					},
				}"
			></button>
		</div>
	</ng-template>
</p-dialog>
